name: Deploy Blog

on:
  push:
    branches:
      - master

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v3
      - name: Install and run Confgen
        run: |
          sudo apt install -y curl libluajit-5.1-2 unzip
          curl -L https://git.mzte.de/LordMZTE/confgen/releases/download/v0.2.2/confgen-linux-x86_64.zip -o confgen.zip
          unzip confgen.zip -d /tmp/confgen
          /tmp/confgen/bin/confgen confgen.lua _site/
      - name: Deply to Webhook
        run: |
          curl -X POST -H "Content-Type: application/json" -d '{"data": [ '"$(find _site -type f -o -type d | sed 's/"/\\"/g' | awk '{printf "\"%s\",\n", $0}' | sed '$ s/,$//')"' ] }' ${{ secrets.WEBHOOK_URL }}
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{steps.deployment.outputs.page_url}}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
